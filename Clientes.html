<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockFlow | CRM Clientes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366F1',
                        secondary: '#4F46E5',
                        bgLight: '#F3F4F6',
                        gold: '#F59E0B',
                        success: '#10B981',
                        danger: '#EF4444'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Línea de tiempo vertical */
        .timeline-line::before {
            content: '';
            position: absolute;
            top: 20px;
            bottom: 0;
            left: 15px;
            width: 2px;
            background: #E5E7EB;
            z-index: 0;
        }
        /* Scrollbar personalizado delgado */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #a0a0a0; }
        
        .client-item.active { background-color: #EEF2FF; border-left-color: #6366F1; }
    </style>
</head>
<body class="bg-bgLight h-screen overflow-hidden flex text-gray-800">

    <!-- TOAST NOTIFICATIONS -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>

    <!-- SIDEBAR PRINCIPAL -->
    <aside class="w-20 bg-white border-r border-gray-200 flex flex-col items-center py-6 z-20 shadow-lg flex-shrink-0">
        <div class="w-10 h-10 bg-gradient-to-br from-primary to-secondary rounded-lg flex items-center justify-center text-white font-bold mb-8 shadow-md">S</div>
        <nav class="flex-1 space-y-4 w-full flex flex-col items-center">
            <a href="Dashboard.html" class="text-gray-400 hover:text-primary hover:bg-indigo-50 p-3 rounded-xl transition-all" title="Dashboard">
                <i class="fas fa-chart-pie text-xl"></i>
            </a>
            <a href="POS.html" class="text-gray-400 hover:text-primary hover:bg-indigo-50 p-3 rounded-xl transition-all" title="POS">
                <i class="fas fa-cash-register text-xl"></i>
            </a>
            <a href="Inventario.html" class="text-gray-400 hover:text-primary hover:bg-indigo-50 p-3 rounded-xl transition-all" title="Inventario">
                <i class="fas fa-boxes text-xl"></i>
            </a>
            <a href="Clientes.html" class="text-primary bg-blue-50 p-3 rounded-xl transition shadow-inner relative group" title="Clientes">
                <i class="fas fa-users text-xl"></i>
                <span class="absolute right-2 top-2 w-2 h-2 bg-success rounded-full ring-2 ring-white"></span>
            </a>
            <a href="Marketing.html" class="text-gray-400 hover:text-primary hover:bg-indigo-50 p-3 rounded-xl transition-all" title="Marketing">
                <i class="fas fa-bullhorn text-x1"></i>
            </a>
        </nav>
        <button onclick="logout()" class="text-gray-400 hover:text-danger mt-auto p-3 rounded-xl hover:bg-red-50 transition">
            <i class="fas fa-power-off text-xl"></i>
        </button>
    </aside>

    <!-- COLUMNA IZQUIERDA: LISTA DE CLIENTES -->
    <div class="w-1/3 bg-white border-r border-gray-200 flex flex-col min-w-[320px] max-w-md z-10">
        
        <!-- Header Lista -->
        <div class="p-5 border-b border-gray-100 bg-white">
            <h2 class="font-bold text-xl text-gray-800 mb-4 tracking-tight">Cartera de Clientes</h2>
            <div class="relative group">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-primary transition"></i>
                <input type="text" id="searchInput" onkeyup="filterClients()" placeholder="Buscar por nombre o DNI..." class="w-full pl-10 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:bg-white transition-all text-sm">
            </div>
            <div class="flex gap-2 mt-4 overflow-x-auto no-scrollbar" id="filter-container">
                <button onclick="setFilter('all')" class="filter-btn active text-xs bg-primary text-white px-3 py-1.5 rounded-full cursor-pointer shadow-sm transition">Todos</button>
                <button onclick="setFilter('VIP')" class="filter-btn text-xs bg-gray-100 text-gray-600 px-3 py-1.5 rounded-full hover:bg-gray-200 cursor-pointer transition">VIP</button>
                <button onclick="setFilter('Deudor')" class="filter-btn text-xs bg-gray-100 text-gray-600 px-3 py-1.5 rounded-full hover:bg-gray-200 cursor-pointer transition">Deudores</button>
                <button onclick="setFilter('Nuevo')" class="filter-btn text-xs bg-gray-100 text-gray-600 px-3 py-1.5 rounded-full hover:bg-gray-200 cursor-pointer transition">Nuevos</button>
            </div>
        </div>

        <!-- Lista Dinámica -->
        <div class="flex-1 overflow-y-auto custom-scroll" id="client-list">
            <!-- SE LLENA CON JS -->
        </div>
        
        <!-- Botón Agregar -->
        <div class="p-4 border-t border-gray-200 bg-gray-50">
            <button onclick="openModal()" class="w-full bg-gray-800 text-white py-3 rounded-xl text-sm font-bold hover:bg-gray-900 shadow-lg transform transition active:scale-95 flex items-center justify-center gap-2">
                <i class="fas fa-plus"></i> Nuevo Cliente
            </button>
        </div>
    </div>

    <!-- COLUMNA DERECHA: DETALLE DEL CLIENTE -->
    <main class="flex-1 overflow-y-auto bg-bgLight p-4 md:p-8 custom-scroll relative">
        
        <!-- CONTENEDOR DE DETALLE (Se actualiza con JS) -->
        <div id="client-detail-view" class="max-w-5xl mx-auto animate-fade-in">
            
            <!-- 1. HEADER PERFIL -->
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-200 mb-6 relative overflow-hidden">
                <!-- Background Decoration -->
                <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-50 rounded-bl-full -mr-10 -mt-10 z-0"></div>
                
                <div class="relative z-10 flex flex-col md:flex-row justify-between items-start gap-6">
                    <div class="flex gap-6 items-center">
                        <div class="relative">
                            <img id="detail-avatar" src="" class="w-24 h-24 rounded-full border-4 border-white shadow-lg bg-gray-200 object-cover">
                            <div id="detail-status-badge" class="absolute bottom-1 right-1 w-5 h-5 bg-green-500 border-2 border-white rounded-full"></div>
                        </div>
                        <div>
                            <h1 id="detail-name" class="text-3xl font-bold text-gray-900 mb-1">Cargando...</h1>
                            <div class="flex flex-col sm:flex-row sm:items-center gap-2 text-sm text-gray-500">
                                <span><i class="fas fa-id-card mr-1"></i> <span id="detail-dni">...</span></span>
                                <span class="hidden sm:inline">•</span>
                                <span><i class="fas fa-map-marker-alt mr-1"></i> <span id="detail-location">...</span></span>
                                <span class="hidden sm:inline">•</span>
                                <span><i class="fas fa-phone mr-1"></i> <span id="detail-phone">...</span></span>
                            </div>
                            
                            <!-- Botones de Acción -->
                            <div class="mt-4 flex gap-3">
                                <button onclick="contactWhatsApp()" class="text-sm bg-green-50 text-green-600 px-4 py-2 rounded-xl border border-green-200 font-bold flex items-center gap-2 hover:bg-green-100 transition shadow-sm">
                                    <i class="fab fa-whatsapp text-lg"></i> WhatsApp
                                </button>
                                <button class="text-sm bg-white text-gray-600 px-4 py-2 rounded-xl border border-gray-200 font-medium flex items-center gap-2 hover:bg-gray-50 transition shadow-sm">
                                    <i class="fas fa-envelope"></i> Email
                                </button>
                                <button class="text-sm bg-white text-gray-400 px-3 py-2 rounded-xl border border-gray-200 hover:text-primary hover:border-primary transition">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tarjeta de Puntos -->
                    <div class="text-right bg-white/50 backdrop-blur-sm p-2 rounded-xl">
                        <div class="inline-block bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-5 py-3 rounded-xl shadow-lg shadow-orange-100">
                            <p class="text-xs font-bold uppercase opacity-90 tracking-wider">StockFlow Points</p>
                            <p class="text-3xl font-bold flex items-center justify-end gap-2 mt-1">
                                <i class="fas fa-crown text-lg"></i> <span id="detail-points">0</span>
                            </p>
                        </div>
                        <p class="text-xs text-gray-400 mt-2 font-medium" id="detail-level-msg">Faltan puntos para subir de nivel</p>
                    </div>
                </div>
                
                <!-- Estadísticas Rápidas -->
                <div class="grid grid-cols-3 gap-4 mt-8 pt-6 border-t border-gray-100">
                    <div class="text-center border-r border-gray-100">
                        <p class="text-xs text-gray-400 uppercase tracking-wide font-bold">Total Gastado</p>
                        <p class="font-bold text-xl text-gray-800 mt-1" id="detail-spent">S/ 0.00</p>
                    </div>
                    <div class="text-center border-r border-gray-100">
                        <p class="text-xs text-gray-400 uppercase tracking-wide font-bold">Ticket Promedio</p>
                        <p class="font-bold text-xl text-gray-800 mt-1" id="detail-avg">S/ 0.00</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-400 uppercase tracking-wide font-bold">Visitas Totales</p>
                        <p class="font-bold text-xl text-gray-800 mt-1" id="detail-visits">0</p>
                    </div>
                </div>
            </div>

            <!-- 2. GRID INFERIOR -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Columna Izquierda: Insights AI -->
                <div class="lg:col-span-1 space-y-6">
                    <!-- AI Card -->
                    <div class="bg-gradient-to-br from-white to-indigo-50 rounded-2xl shadow-sm border border-indigo-100 p-5 relative overflow-hidden group hover:shadow-md transition">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-robot text-primary animate-pulse"></i> StockFlow AI
                        </h3>
                        <p class="text-sm text-gray-600 mb-4 leading-relaxed" id="detail-ai-msg">
                            Analizando patrones de compra...
                        </p>
                        
                        <div class="bg-white p-3 rounded-xl flex items-center gap-3 border border-gray-200 shadow-sm">
                            <div class="w-12 h-12 bg-gray-50 rounded-lg flex items-center justify-center text-gray-400 text-xl">
                                <i class="fas fa-gift text-primary"></i>
                            </div>
                            <div>
                                <p class="font-bold text-sm text-gray-800">Sugerencia</p>
                                <p class="text-xs text-primary font-bold" id="detail-ai-suggestion">Oferta personalizada</p>
                            </div>
                        </div>
                    </div>

                    <!-- Intereses Tags -->
                    <div class="bg-white rounded-2xl shadow-sm p-5 border border-gray-100">
                        <h3 class="font-bold text-gray-800 mb-3 text-sm flex items-center gap-2">
                            <i class="fas fa-tags text-gray-400"></i> Intereses Detectados
                        </h3>
                        <div class="flex flex-wrap gap-2" id="detail-interests">
                            <!-- Tags JS -->
                        </div>
                    </div>
                </div>

                <!-- Columna Derecha: Timeline -->
                <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm p-6 border border-gray-100">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-gray-800">Historial de Actividad</h3>
                        <button class="text-xs text-primary font-medium hover:underline">Ver todo</button>
                    </div>
                    
                    <div class="relative pl-4 timeline-line space-y-8" id="detail-timeline">
                        <!-- Timeline JS -->
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- MODAL NUEVO CLIENTE -->
    <div id="newClientModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg animate-fade-in">
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4 border-b border-gray-100">
                    <h3 class="text-lg font-bold leading-6 text-gray-900">Registrar Nuevo Cliente</h3>
                </div>
                <form onsubmit="saveClient(event)" class="p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo</label>
                            <input type="text" id="new-name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">DNI / RUC</label>
                            <input type="text" id="new-dni" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                            <input type="text" id="new-phone" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary outline-none">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Correo Electrónico</label>
                            <input type="email" id="new-email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary outline-none">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ubicación</label>
                            <input type="text" id="new-location" placeholder="Ej: Lima, Miraflores" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-primary outline-none">
                        </div>
                    </div>
                    <div class="pt-4 flex flex-row-reverse gap-3">
                        <button type="submit" class="w-full justify-center rounded-xl bg-primary px-3 py-2 text-sm font-bold text-white shadow-sm hover:bg-secondary sm:w-auto transition">Guardar</button>
                        <button type="button" onclick="closeModal()" class="w-full justify-center rounded-xl bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:w-auto transition">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- LOGICA JAVASCRIPT -->
    <script>
        // --- 1. DATOS SIMULADOS (MOCK DATA) ---
        let clients = [
            {
                id: 1,
                name: "María Pérez",
                dni: "45678901",
                phone: "999888777",
                email: "maria.perez@gmail.com",
                location: "Lima, San Isidro",
                type: "VIP",
                points: 2450,
                spent: 4520.00,
                visits: 12,
                avg: 376.66,
                lastVisit: "Hace 2 días",
                interests: ["Ropa Mujer", "Deportes", "Ofertas"],
                avatar: "https://ui-avatars.com/api/?name=Maria+Perez&background=c7d2fe&color=3730a3",
                history: [
                    { type: "purchase", title: "Compra en Tienda (#9920)", date: "Hace 2 días", desc: "2x Leggins Deportivos, 1x Agua", amount: "+ S/ 120.00" },
                    { type: "points", title: "Canje de Puntos", date: "Hace 1 semana", desc: "Canjeó cupón de descuento del 10%.", amount: "- 200 pts" },
                    { type: "email", title: "Campaña Email", date: "Hace 3 semanas", desc: "Abrió: '¡Te extrañamos María!'", amount: "" }
                ]
            },
            {
                id: 2,
                name: "Carlos Ruiz",
                dni: "12345678",
                phone: "987654321",
                email: "carlos.r@hotmail.com",
                location: "Arequipa, Centro",
                type: "Nuevo",
                points: 50,
                spent: 120.00,
                visits: 1,
                avg: 120.00,
                lastVisit: "Hace 1 mes",
                interests: ["Tecnología"],
                avatar: "https://ui-avatars.com/api/?name=Carlos+Ruiz&background=random",
                history: [
                    { type: "purchase", title: "Primera Compra (#8801)", date: "Hace 1 mes", desc: "1x Audífonos Sony", amount: "+ S/ 120.00" }
                ]
            },
            {
                id: 3,
                name: "Ana Gómez",
                dni: "77665544",
                phone: "912345678",
                email: "ana.gomez@empresa.com",
                location: "Lima, Miraflores",
                type: "Regular",
                points: 500,
                spent: 850.50,
                visits: 5,
                avg: 170.10,
                lastVisit: "Hoy",
                interests: ["Snacks", "Bebidas", "Oficina"],
                avatar: "https://ui-avatars.com/api/?name=Ana+Gomez&background=random",
                history: [
                    { type: "purchase", title: "Compra Rápida (#9945)", date: "Hoy, 10:30 AM", desc: "Pack Bebidas, Snacks varios", amount: "+ S/ 45.50" },
                    { type: "purchase", title: "Compra (#9800)", date: "Hace 2 semanas", desc: "Suministros oficina", amount: "+ S/ 210.00" }
                ]
            },
            {
                id: 4,
                name: "Jorge Luis",
                dni: "88888888",
                phone: "955555555",
                email: "jorge@mail.com",
                location: "Cusco",
                type: "Deudor",
                points: 0,
                spent: 200.00,
                visits: 2,
                avg: 100.00,
                lastVisit: "Hace 3 meses",
                interests: [],
                avatar: "https://ui-avatars.com/api/?name=Jorge+Luis&background=fee2e2&color=991b1b",
                history: [
                    { type: "alert", title: "Pago Pendiente", date: "Hace 3 meses", desc: "Deuda vencida factura #F001", amount: "S/ 200.00" }
                ]
            }
        ];

        let currentFilter = 'all';
        let selectedClientId = 1;

        // --- 2. INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            renderList();
            selectClient(1); // Seleccionar el primero por defecto
        });

        function checkAuth() {
            if (!localStorage.getItem('stockflow_session')) window.location.href = 'Login.html';
        }

        // --- 3. RENDERIZADO DE LISTA ---
        function renderList() {
            const listContainer = document.getElementById('client-list');
            const search = document.getElementById('searchInput').value.toLowerCase();
            listContainer.innerHTML = '';

            const filtered = clients.filter(c => {
                const matchSearch = c.name.toLowerCase().includes(search) || c.dni.includes(search);
                const matchFilter = currentFilter === 'all' || c.type === currentFilter;
                return matchSearch && matchFilter;
            });

            if(filtered.length === 0) {
                listContainer.innerHTML = `<div class="p-8 text-center text-gray-400"><p>No se encontraron clientes.</p></div>`;
                return;
            }

            filtered.forEach(c => {
                const badgeColor = getBadgeColor(c.type);
                const isActive = c.id === selectedClientId ? 'active border-l-4 border-l-primary bg-indigo-50' : 'hover:bg-gray-50 border-l-4 border-l-transparent';
                
                const div = document.createElement('div');
                div.className = `p-4 border-b border-gray-50 cursor-pointer transition client-item ${isActive}`;
                div.onclick = () => selectClient(c.id);
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <img src="${c.avatar}" class="w-12 h-12 rounded-full object-cover border border-gray-200">
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <h3 class="font-bold text-gray-800 text-sm">${c.name}</h3>
                                <span class="text-[10px] ${badgeColor} px-1.5 py-0.5 rounded font-bold uppercase shadow-sm">${c.type}</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1 flex justify-between">
                                <span><i class="fas fa-clock mr-1"></i>${c.lastVisit}</span>
                            </p>
                        </div>
                    </div>
                `;
                listContainer.appendChild(div);
            });
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if(btn.textContent.includes(filter === 'all' ? 'Todos' : (filter === 'VIP' ? 'VIP' : (filter === 'Deudor' ? 'Deudores' : 'Nuevos')))) {
                    btn.classList.add('bg-primary', 'text-white', 'shadow-sm');
                    btn.classList.remove('bg-gray-100', 'text-gray-600');
                } else {
                    btn.classList.remove('bg-primary', 'text-white', 'shadow-sm');
                    btn.classList.add('bg-gray-100', 'text-gray-600');
                }
            });
            renderList();
        }

        function filterClients() {
            renderList();
        }

        // --- 4. RENDERIZADO DE DETALLE (CORE) ---
        function selectClient(id) {
            selectedClientId = id;
            renderList(); // Para actualizar el estado "active"

            const client = clients.find(c => c.id === id);
            if(!client) return;

            // Header
            document.getElementById('detail-name').innerText = client.name;
            document.getElementById('detail-dni').innerText = client.dni;
            document.getElementById('detail-location').innerText = client.location;
            document.getElementById('detail-phone').innerText = client.phone;
            document.getElementById('detail-avatar').src = client.avatar;
            document.getElementById('detail-points').innerText = client.points.toLocaleString();
            
            // Stats
            document.getElementById('detail-spent').innerText = `S/ ${client.spent.toLocaleString('es-PE', {minimumFractionDigits: 2})}`;
            document.getElementById('detail-avg').innerText = `S/ ${client.avg.toLocaleString('es-PE', {minimumFractionDigits: 2})}`;
            document.getElementById('detail-visits').innerText = client.visits;

            // AI Logic Mockup
            const aiMsg = document.getElementById('detail-ai-msg');
            const aiSugg = document.getElementById('detail-ai-suggestion');
            
            if(client.type === 'VIP') {
                aiMsg.innerText = "Cliente de alto valor. Prefiere calidad sobre precio.";
                aiSugg.innerText = "Acceso anticipado a Nueva Colección";
            } else if (client.type === 'Deudor') {
                aiMsg.innerText = "⚠️ Cliente con pagos pendientes. Restringir crédito.";
                aiSugg.innerText = "Recordatorio de pago amable";
            } else {
                aiMsg.innerText = "Basado en su última compra, podría interesarle:";
                aiSugg.innerText = "Cupón 10% en próxima visita";
            }

            // Interests
            const interestsContainer = document.getElementById('detail-interests');
            interestsContainer.innerHTML = '';
            if(client.interests.length > 0) {
                client.interests.forEach(tag => {
                    interestsContainer.innerHTML += `<span class="bg-indigo-50 text-primary px-3 py-1 rounded-full text-xs font-bold border border-indigo-100">${tag}</span>`;
                });
            } else {
                interestsContainer.innerHTML = `<span class="text-xs text-gray-400 italic">Sin datos suficientes</span>`;
            }

            // Timeline
            const timelineContainer = document.getElementById('detail-timeline');
            timelineContainer.innerHTML = '';
            client.history.forEach(h => {
                let colorClass = 'bg-gray-400';
                let icon = 'fa-circle';
                if(h.type === 'purchase') { colorClass = 'bg-green-500'; icon = 'fa-shopping-bag'; }
                if(h.type === 'points') { colorClass = 'bg-yellow-400'; icon = 'fa-star'; }
                if(h.type === 'alert') { colorClass = 'bg-red-500'; icon = 'fa-exclamation'; }
                if(h.type === 'email') { colorClass = 'bg-blue-400'; icon = 'fa-envelope'; }

                const div = document.createElement('div');
                div.className = 'relative z-10';
                div.innerHTML = `
                    <div class="absolute -left-[23px] top-1 w-6 h-6 ${colorClass} rounded-full border-2 border-white shadow-sm flex items-center justify-center text-white text-[10px]">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="flex justify-between items-start group">
                        <div class="bg-white p-3 rounded-lg border border-transparent group-hover:border-gray-100 group-hover:shadow-sm transition w-full mr-4">
                            <p class="font-bold text-gray-800 text-sm">${h.title}</p>
                            <p class="text-xs text-gray-400 mb-1"><i class="far fa-clock mr-1"></i> ${h.date}</p>
                            <p class="text-xs text-gray-600">${h.desc}</p>
                        </div>
                        <span class="font-bold text-sm ${h.amount.includes('+') ? 'text-gray-800' : 'text-red-500'} whitespace-nowrap mt-2">${h.amount}</span>
                    </div>
                `;
                timelineContainer.appendChild(div);
            });
        }

        // --- 5. UTILIDADES Y MODAL ---
        function getBadgeColor(type) {
            if(type === 'VIP') return 'bg-yellow-100 text-yellow-700';
            if(type === 'Nuevo') return 'bg-blue-100 text-blue-700';
            if(type === 'Deudor') return 'bg-red-100 text-red-700';
            return 'bg-gray-100 text-gray-600';
        }

        function openModal() {
            document.getElementById('newClientModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('newClientModal').classList.add('hidden');
        }

        function saveClient(e) {
            e.preventDefault();
            const name = document.getElementById('new-name').value;
            const newClient = {
                id: Date.now(),
                name: name,
                dni: document.getElementById('new-dni').value,
                phone: document.getElementById('new-phone').value,
                location: document.getElementById('new-location').value || "Sin dirección",
                type: "Nuevo",
                points: 0,
                spent: 0,
                visits: 0,
                avg: 0,
                lastVisit: "Hoy",
                interests: [],
                avatar: `https://ui-avatars.com/api/?name=${name.replace(' ', '+')}&background=random`,
                history: [{ type: "email", title: "Registro", date: "Hoy", desc: "Cliente registrado en sistema", amount: "" }]
            };
            
            clients.unshift(newClient); // Agregar al inicio
            closeModal();
            setFilter('all'); // Resetear filtro para ver el nuevo
            selectClient(newClient.id); // Seleccionarlo
            showToast("Cliente registrado exitosamente");
        }

        function contactWhatsApp() {
            const client = clients.find(c => c.id === selectedClientId);
            if(client) {
                const msg = `Hola ${client.name}, te escribimos de StockFlow para...`;
                window.open(`https://wa.me/51${client.phone}?text=${encodeURIComponent(msg)}`, '_blank');
            }
        }

        function showToast(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'bg-gray-800 text-white px-4 py-3 rounded-xl shadow-lg flex items-center gap-3 animate-fade-in mb-2';
            toast.innerHTML = `<i class="fas fa-check-circle text-green-400"></i> <span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function logout() {
            if(confirm('¿Cerrar sesión?')) {
                localStorage.removeItem('stockflow_session');
                window.location.href = 'Login.html';
            }
        }
    </script>
</body>
</html>